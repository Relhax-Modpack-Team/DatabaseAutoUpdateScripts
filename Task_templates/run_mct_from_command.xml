<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<AutomationSequence documentVersion="1.0">
  <!-- run_mct_from_command.xml
    Author:  Willster419
    Created: 2021-08-15
    This sequence template downloads and extracts the mct zip file from the developer website, and runs the executable
    Required macros:
    {mct_commands}     - The commands to send to the MCT application
    {mct_wotmod_name}  - The name to use for the wotmod
   -->
  <TaskDefinitions>
    <!-- import getting the wot directory path without the exe -->
    <Task ID="import_create_workDirs_macros" Command="import_task" RepoUrlPath="Task_templates/create_workDirs_macros.xml"/>

    <!-- import getting the wot directory path without the exe -->
    <Task ID="import_get_wot_path_no_exe" Command="import_task" RepoUrlPath="Task_templates/get_wot_path_no_exe.xml"/>

    <!-- create the required macros and directories -->
    <Task ID="create_mct_dir_macro" Command="macro_create" MacroName="working_folder_mct" MacroValue="{workDirectory}\MCT"/>
    <Task ID="create_directory_mct" Command="create_directory" DirectoryPath="{working_folder_mct}"/>
    <!-- <Task ID="create_mct_macro" Command="macro_create" MacroName="koreanrandom_attachment_name" MacroValue="MCTCreator"/> -->

    <!-- download the mct exe -->
    <!--<Task ID="download_mct_from_devUrl" Command="download_browser" Url="https://koreanrandom.com/forum/topic/1578-"
      HtmlPath="{koreanrandom_attachment_xpath}" DestinationPath="{working_folder_mct}\MCT.zip" WaitTimeMs="500" WaitCounts="6" BrowserHeight="0" BrowserWidth="0"/> -->
    <Task ID="download_mct_github" Command="download_static" Url="https://github.com/Relhax-Modpack-Team/RelhaxMCT/raw/master/MCTCreator/MCTCreator2.exe" DestinationPath="{working_folder_mct}\MCTCreator2.exe" />
    <!-- <Task ID="extract_mct" Command="shell_exec" Filename="7z.exe" Wd="{working_folder_mct}" Cmd="e MCT.zip -r"/> -->

    <!-- download the modpack current zip file-->
    <Task ID="download_modpack" Command="package_download" FilePath="{working_folder_modpack}\{packageName}.zip"/>

    <!-- extract the modpack wotmod -->
    <!-- 'e' means to extract (to the work direcotry, without using the zip file's paths), and -r means to recurse into the zip folder's directories -->
    <Task ID="extract_modpack" Command="shell_exec" Filename="7z.exe" Wd="{working_folder_modpack}" Cmd="e {packageName}.zip {mct_wotmod_name} -r"/>

    <!-- Run the MCT exe -->
    <Task ID="run_mct" Command="shell_exec" Filename="{working_folder_mct}\MCTCreator2.exe" Wd="{working_folder_mct}" Cmd="/wot-path=&quot;{clientPathNoExe}\&quot; /mods-path=&quot;{working_folder_mct}&quot; /auto-close-console {mct_commands}"/>

    <!-- get the filename and rename to what's used in the modpack -->
    <Task ID="get_mct_wotmod_filename" Command="directory_search" DirectoryPath="{working_folder_mct}" SearchPattern="mod.MCTCreator.*.wotmod" Recursive="False" MacroPrefix="mct_filename_from_shell"/>
    <Task ID="rename_wotmod" Command="file_move" SourceFilePath="{mct_filename_from_shell_0}" DestinationFilePath="{working_folder_mct}\{mct_wotmod_name}"/>

    <!-- compare the hashes of the complete packages. this is done in 3 steps:
      1. write the compare_start task (resets the internal counters for matches and differences)
      2. use compare tasks to compare files on disk or an entry in a zip file
      3. write the compare_end task (evaluates the counts from the compare tasks)
          if compare_end finds 0 differences, then the automation process will end early (nothing to update)

      By using the directory_compare task, if the number of swf's change between the modpack and source, something has changed in the structure and we need to account for it
    -->
    <Task ID="compare_start" Command="compare_start"/>
    <Task ID="compare_contour_icons" Command="file_compare" FileA="{working_folder_modpack}\{mct_wotmod_name}" FileB="{working_folder_mct}\{mct_wotmod_name}"/>
    <Task ID="compare_end" Command="compare_end"/>

    <!-- move the target wotmod into the package folder -->
    <Task ID="move_wotmod" Command="file_move" SourceFilePath="{working_folder_mct}\{mct_wotmod_name}" DestinationFilePath="{working_folder_package}\zip\mods\versiondir\{mct_wotmod_name}"/>

    <!-- create the new zip -->
    <Task ID="create_zip" Command="shell_exec" Filename="7z.exe" Wd="{working_folder_package}\zip" Cmd="a -tzip -mx=9 -r final.zip mods"/>

    <!-- upload to the server -->
    <Task ID="upload_zip" Command="package_upload" FilePath="{working_folder_package}\zip\final.zip" ZipFileName="{packageName}_{clientVersion}_{date}.zip"/>
  </TaskDefinitions>
</AutomationSequence>