<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<AutomationSequence documentVersion="1.0">
  <!-- Specify macros here -->
  <Macros>
    <Macro Name="mods_resMods_folders" Value="mods"/>
    <Macro Name="download_url" Value="https://github.com/AstaRom/wot_mods/raw/master/hangarAddons.zip"/>
  </Macros>
  <TaskDefinitions>
  
  
    <Task ID="import_createWorkDirs" Command="import_task" RepoUrlPath="Task_templates/macro_create_work_dirs.xml"/>    
      
     <!-- download the source zip file, which implicitly creates the directories  -->
    <Task ID="download_source" Command="download_static" Url="{download_url}" DestinationPath="{working_folder_source}\{last_download_filename}"/>
    <!-- extract the source wotmod files-->
    <Task ID="extract_source_1" Command="shell_exec" Filename="7z.exe" Wd="{working_folder_source}" Cmd="x {last_download_filename} coreMods.wotmod -r"/>
    <Task ID="extract_source_2" Command="shell_exec" Filename="7z.exe" Wd="{working_folder_source}" Cmd="x {last_download_filename} hideHangarElements.wotmod -r"/>
    <Task ID="extract_source_3" Command="shell_exec" Filename="7z.exe" Wd="{working_folder_source}" Cmd="x {last_download_filename} hideHangarElements.json -r"/>
    
    <!-- download the modpack current zip file, which implicitly creates the directories  -->
    <Task ID="download_modpack" Command="package_download" FilePath="{working_folder_modpack}\{packageName}.zip"/>
    <!-- extract the modpack wotmod files-->
    <Task ID="extract_modpack_1" Command="shell_exec" Filename="7z.exe" Wd="{working_folder_modpack}" Cmd="x {packageName}.zip coreMods.wotmod -r"/>
    <Task ID="extract_modpack_2" Command="shell_exec" Filename="7z.exe" Wd="{working_folder_modpack}" Cmd="x {packageName}.zip hideHangarElements.wotmod -r"/>
    <Task ID="extract_modpack_3" Command="shell_exec" Filename="7z.exe" Wd="{working_folder_modpack}" Cmd="x {packageName}.zip hideHangarElements.json -r"/>

    <!-- compare the hashes  -->
    <Task ID="compare_start" Command="compare_start"/>
    <!-- Compare wotmod -->
    <Task ID="compare_wotmod" Command="file_compare"
      FileA="{working_folder_source}\hideHangarElements\mods\{clientVersion}\hangarAddons\hideHangarElements.wotmod"
      FileB="{working_folder_modpack}\mods\versiondir\hangarAddons\hideHangarElements.wotmod"/>
    <!-- Compare config / inverse -->
    <!-- sequence should stop when there are changes to the cfg file -->
    <Task ID="compare_cfg" Command="file_compare_inverse"
      FileA="{working_folder_source}\hideHangarElements\mods\configs\hangarAddons\hideHangarElements.json"
      FileB="{working_folder_modpack}\mods\configs\hangarAddons\hideHangarElements.json"/>
    <Task ID="compare_end" Command="compare_end"/>

    <!-- if the comparison is good, meaning there is an update, then we want to copy the source into a new 'final' folder and upload -->
    <Task ID="create_source_dir_post_compare" Command="create_directory" DirectoryPath="{workDirectory}\package\mods\versiondir"/>
    <Task ID="move_source_post_compare" Command="file_copy" SourceFilePath="{working_folder_source}\hideHangarElements\mods\{clientVersion}\hangarAddons\hideHangarElements.wotmod" DestinationFilePath="{workDirectory}\package\mods\versiondir\hideHangarElements.wotmod"/>
    <Task ID="move_source_post_compare2" Command="file_copy" SourceFilePath="{working_folder_source}\hideHangarElements\mods\{clientVersion}\hangarAddons\coreMods.wotmod" DestinationFilePath="{workDirectory}\package\mods\versiondir\coreMods.wotmod"/>
    <Task ID="move_source_post_compare3" Command="file_copy" SourceFilePath="{working_folder_source}\hideHangarElements\mods\configs\hangarAddons\hideHangarElements.json" DestinationFilePath="{workDirectory}\package\mods\configs\hangarAddons\hideHangarElements.json"/>

    <!-- create the new zip
      "a" is to add to an archive. In this case because it's the first file, the archive is created for the first time.
      -tzip is to create a zip format archive
      -mx=9 is setting the level of compression to 9 (scale goes from 0 [store] to 9[ultra])
      -r recurse subdirectories
    -->
    <Task ID="create_zip" Command="shell_exec" Filename="7z.exe" Wd="{workDirectory}\package" Cmd="{7z_create_package_zipfile}"/>

    <!-- update version field in database (using clientVersion for this mod) -->
    <Task ID="update_package_version" Command="update_package_property" PropertyName="Version" PropertyValue="{clientVersion}" />

    <!-- upload to the server -->
    <Task ID="upload_zip" Command="package_upload" FilePath="{workDirectory}\package\final.zip" ZipFileName="{packageName}_{clientVersion}_{date}.zip"/>


  </TaskDefinitions>
</AutomationSequence>